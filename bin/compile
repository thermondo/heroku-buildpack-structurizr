#!/usr/bin/env bash

# Usage:
#
#     $ bin/compile <build-dir> <cache-dir> <env-path>

# Fail fast and fail hard.
set -eo pipefail

# Paths.
BIN_DIR=$(cd "$(dirname "$0")"; pwd) # absolute path
# ROOT_DIR=$(dirname "$BIN_DIR")
BUILD_DIR=$1
# CACHE_DIR=$2
# ENV_DIR=$3

# shellcheck source=bin/utils.sh
source "$BIN_DIR/utils.sh"

curl_dl() {
    # add standard "fail fast" parameters to a curl
    curl --silent --fail --show-error --location "${@}"
}

puts-step "read current version"
if [ "${STRUCTURIZR_BUILD:-}" == "" ]; then
    version="$(curl_dl https://structurizr.com/help/build/number)"
else
    version="${STRUCTURIZR_BUILD}"
fi
url="https://github.com/structurizr/lite/releases/download/v${version}/structurizr-lite.war"

puts-step "downloading Structurizr build $version"
curl_dl "$url" -o "$BUILD_DIR/structurizr-lite.war"
